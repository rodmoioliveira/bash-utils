name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  TRACE: 0

jobs:
  tests-linux:
    name: '[bash-utils] Test on ${{ matrix.image.distro }}'

    runs-on: 'ubuntu-latest'

    strategy:
      fail-fast: false
      matrix:
        image:
          - { distro: 'ubuntu:latest' }
          - { distro: 'alpine:latest' }
          # - { distro: 'centos:latest' }
          # - { distro: 'fedora:latest' }
          # - { distro: 'archlinux:latest' }

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies ${{ matrix.image.distro }}
      run: make dependencies

    - name:  Check format bash code ${{ matrix.image.distro }}
      run: make fmt-check

    - name:  Check lint bash code ${{ matrix.image.distro }}
      run: make lint-check

    - name: Check typos ${{ matrix.image.distro }}
      run: make typos

    - name: Add symlink to scripts in path ${{ matrix.image.distro }}
      run: make symlink

    - name: Run tests ${{ matrix.image.distro }}
      run: source ~/.bash_profile; make tests

  tests-mac:
    name: '[bash-utils] Test on ${{ matrix.os }}'

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false

      matrix:
        include:
          - { os: macos-latest }

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies ${{ matrix.os }}
      run: make dependencies

    - name:  Check format bash code ${{ matrix.os }}
      run: make fmt-check

    - name:  Check lint bash code ${{ matrix.os }}
      run: make lint-check

    - name: Check typos ${{ matrix.os }}
      run: make typos

    - name: Add symlink to scripts in path ${{ matrix.os }}
      run: make symlink

    - name: Run tests ${{ matrix.os }}
      run: source ~/.bash_profile; make tests
